name: Code Quality

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  swiftlint:
    name: SwiftLint
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SwiftLint
      run: |
        brew install swiftlint

    - name: Run SwiftLint
      run: |
        swiftlint --strict --reporter github-actions-logging

    - name: SwiftLint Report
      if: failure()
      run: |
        echo "SwiftLint found issues. Please fix them before merging."
        swiftlint --reporter emoji

  swiftformat:
    name: SwiftFormat
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SwiftFormat
      run: |
        brew install swiftformat

    - name: Check SwiftFormat
      run: |
        swiftformat --lint Sources/ Tests/

    - name: SwiftFormat Report
      if: failure()
      run: |
        echo "Code formatting issues found. Please run 'swiftformat Sources/ Tests/' locally."

  security-audit:
    name: Security Audit
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for sensitive files
      run: |
        # æª¢æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿæª”æ¡ˆè¢«èª¤commit
        echo "ğŸ” Checking for sensitive files..."
        SENSITIVE_FILES=$(find . -name "*.key" -o -name "*.pem" -o -name "*.p12" | grep -v ".build" || true)
        echo "Debug: Found files: '$SENSITIVE_FILES'"

        if [ -n "$SENSITIVE_FILES" ]; then
          echo "âŒ Found potential sensitive files:"
          echo "$SENSITIVE_FILES"
          exit 1
        fi

        # æª¢æŸ¥ Package.swift ä¸­çš„ä¾è³´
        if grep -q "http://" Package.swift; then
          echo "âš ï¸  Found HTTP dependencies, consider using HTTPS"
        fi

        echo "âœ… Security audit passed"

  dependency-check:
    name: Dependency Check
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check Package Dependencies
      run: |
        echo "ğŸ“¦ Checking Package.swift dependencies..."

        # é©—è­‰ Package.swift èªæ³•
        swift package dump-package > /dev/null

        # åˆ—å‡ºä¾è³´é—œä¿‚
        swift package show-dependencies

        echo "âœ… Dependency check completed"

  build-documentation:
    name: Documentation Build
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Build Documentation
      run: |
        # æª¢æŸ¥æ˜¯å¦å¯ä»¥å»ºç«‹æ–‡æª”
        if [ -d "Sources" ]; then
          echo "ğŸ“š Checking documentation capability..."
          # å˜—è©¦å»ºç«‹å°ˆæ¡ˆä»¥é©—è­‰ä»£ç¢¼çµæ§‹
          swift build
          echo "âœ… Documentation build completed (code structure validated)"
        fi
